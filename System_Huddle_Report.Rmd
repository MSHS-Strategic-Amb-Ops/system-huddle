---
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
    fig_width: 7
    fig_height: 6
resource_files:
- hh_crosswalk.csv
- Rad_Onc_Data.csv
- Radiology_Data.csv
- Radiology_Site_Mapping.csv
- Epic Department Mapping Correction.csv
- hh_crosswalk.csv
- Radiology_Data.csv
- Rad_Onc_Data.csv
- Radiology_Site_Mapping.csv
- Epic Department Mapping Correction.csv
- open_encounters_exclusion.xlsx
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```
<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: auto;
  margin-right: auto;
}
</style>
<style>
.tocify {
color: black;
}
<!-- } -->
<!-- .tocify .tocify-header { -->
<!--     position: fixed; -->
<!--     <!-- top: 50px; --> -->
<!--     left: 50px; -->
<!--     width: 350px; -->
<!--     <!-- border: solid 3px black; --> -->
<!--     <!-- height: 200px; --> -->
<!--  border: none; -->
<!-- } -->
.tocify .tocify-header .active {
color: white;
background: #d80b8c;
font-weight: bold;
}
<!-- .tocify .tocify-item { -->
<!-- background: white; -->
<!-- color: black; -->
<!--  border: none; -->
<!-- } -->
</style>
<style>
  .nav-pills>li>a:hover, .nav-pills>li>a:focus, .nav-pills>li.active>a,     .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus{
     background-color: #212070;
     }
</style>
<style>
.container { width: 1800px; }
h2 {
  background-color: #dddedd;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h3 {
  background-color: #f2f2f2;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h4 {
  <!-- background-color: #dddedd; -->
  <!-- color: black; -->
  text-indent: 50px;
  <!-- font-weight: bold; -->
}
</style>
```{r Load Packages, echo = FALSE, warning = FALSE, message = FALSE}
# Load packages -----------------------------------------------------------------------------------
suppressMessages({
  memory.limit(size = 10000000)
  library(readxl)
  library(writexl)
  library(plyr)
  library(dplyr)
  library(data.table)
  library(zoo)
  library(shiny)
  library(shinydashboard)
  library(shinydashboardPlus)
  library(shinyWidgets)
  library(htmlwidgets)
  library(lubridate)
  library(tcltk)
  library(tidyverse)
  library(plotly)
  library(knitr)
  library(kableExtra)
  library(leaflet)
  library(grid)
  library(gridExtra)
  library(eeptools)
  library(ggQC)
  #library(zipcode)
  library(utils)
  library(scales)
  library(chron)
  library(bupaR)
  library(shiny)
  library(DT)
  library(DiagrammeR)
  library(shinyalert)
  library(edeaR)
  library(processmapR)
  library(processmonitR)
  library(processanimateR)
  library(tidyr)
  library(lubridate)
  library(RColorBrewer)
  library(DiagrammeR)
  library(ggplot2)
  library(leaflet)
  library(readr)
  library(highcharter)
  library(ggforce) # for 'geom_arc_bar'
  library(packcircles) # for packed circle graph
  library(viridis)
  library(ggiraph)
  library(treemapify)
  library(treemap)
  library(broom)
  library(extrafont)
  library(tis) # for US holidays
  library(vroom)
  library(sjmisc)
  library(tools)
  library(here)
  library(shinyBS)
  library(shinyscreenshot)
  library(fasttime)
  library(shinycssloaders)
  library(feather)
  # library(zipcodeR)
  library(formattable)
  library(shinyjs)
  library(janitor)
  library(patchwork)
  library(RODBC)
  library(DBI)
  library(odbc)
})
```


```{r Graph asthetics, echo = FALSE, warning = FALSE, message = FALSE}
### Color Functions for Graphs ============================================================
# Mount Sinai corporate colors "USE THIS TO ADD COLORS"
MountSinai_colors <- c(
  `dark purple`  = "#212070",
  `dark pink`    = "#d80b8c",
  `dark blue`    = "#00aeef",
  `dark grey`    = "#7f7f7f",
  `yellow`       = "#ffc000",
  `purple`       = "#7030a0",
  `med purple`   = "#5753d0",
  `med pink`     = "#f75dbe",
  `med blue`     = "#5cd3ff",
  `med grey`     = "#a5a7a5",
  `light purple` = "#c7c6ef",
  `light pink`   = "#fcc9e9",
  `light blue`   = "#c9f0ff",
  `light grey`   = "#dddedd"
  )
# Function to extract Mount Sinai colors as hex codes
# Use Character names of MountSinai_colors
MountSinai_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (MountSinai_colors)
  
  MountSinai_colors[cols]
}
# Color Function that can be used to call all colors is "MountSinai_cols()"
# Use in ggplot 
  #MountSinai_cols()       # will provide all colors and their hex codes in a table 
  #MountSinai_cols("pink") # will provide color name and the hex code for the pink color
# Create palettes 
MountSinai_palettes <- list(
  `all`   = MountSinai_cols("dark purple","dark pink","dark blue","dark grey",
                            "med purple","med pink","med blue","med grey", 
                            "light purple","light pink","light blue","light grey"),
  
  `main`  = MountSinai_cols("dark purple","dark pink","dark blue","dark grey"),
  
  `purple`  = MountSinai_cols("dark purple","med purple","light purple"),
  
  `pink`  = MountSinai_cols("dark pink","med pink","light pink"),
  
  `blue`  = MountSinai_cols("dark blue", "med blue", "light blue"),
  
  `grey`  = MountSinai_cols("dark grey", "med grey", "light grey"),
  
  `purpleGrey` = MountSinai_cols("dark purple", "dark grey"),
  
  `pinkBlue` = MountSinai_cols("dark pink", "dark blue")
  
)
# MountSinai_palettes
# Return function to interpolate a Mount Sinai color palette
# default value is the main palette, reverse = True will change the order
MountSinai_pal <- function(palette = "all", reverse = FALSE, ...) {
  pal <- MountSinai_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}
# Scale Function for ggplot can be used instead of scale_color_manual
scale_color_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}
# Scale Fill for ggplot insetead of scale_fill_manual 
scale_fill_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  if (discrete) {
    discrete_scale("fill", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}
# Use in ggplot 
  # scale_color_MountSinai("main")
```


```{r Import Data, echo = FALSE, warning = FALSE, message = FALSE}
'%!in%' <- function(x,y)!('%in%'(x,y))
inc_sites <- c("NETWORK","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE","MSDD")


scheduling_data_raw <- as.data.frame(readRDS("/nfs/data/Applications/Ambulatory/Data_Updated/historical_data.rds")) %>%
  filter(!is.na(Campus)) %>%
  filter(Campus %in% c("NETWORK","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE","MSDD"))

# scheduling_data_raw <- as.data.frame(readRDS(file.choose())) %>%
#   filter(!is.na(Campus)) %>%
#   filter(Campus %in% c("NETWORK","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE","MSDD"))

date_start <- as.Date("2021-01-01", format="%Y-%m-%d")
date_end <- as.Date(max(scheduling_data_raw$Appt.Made.DTTM), format="%Y-%m-%d")
# date_start <- as.Date(paste0(format(as.Date(date_end) - 365, "%Y-%m"),"-01"), format="%Y-%m-%d")
```


```{r Process Corrected Epic Departments, echo = FALSE, warning = FALSE, message = FALSE}
# epic_dept_corrected <- read_csv("Epic Department Mapping Correction.csv")
# 
# scheduling_data_raw <- merge(scheduling_data_raw, epic_dept_corrected[,c("Campus","Campus.Specialty","Department","Campus Corrected")])
# scheduling_data_raw <- scheduling_data_raw %>%
#   mutate(Campus = ifelse(is.na(`Campus Corrected`) | `Campus Corrected` == "DEACTIVATE", Campus, `Campus Corrected`)) %>%
#   dplyr::select(-`Campus Corrected`)
```


```{r Import HH Data, echo = FALSE, warning = FALSE, message = FALSE}
# con_hh <- odbcConnect("handhygiene") # Connect to Server
# hh_data_comp_raw <- sqlQuery(con_hh, "SELECT * FROM qidm_dev.dbo.amb_hand_hygiene_comp") # Master Referrals Data
# 
# hh_data_comp_raw_pt_entry <- sqlQuery(con_hh, "SELECT * FROM qidm_dev.dbo.PT_AMB_HAND_HYGIENE_COMP") # Master Referrals Data

# Import Referrals+Visit Data --------------------------------------------------
con_hh <- dbConnect(odbc(),
                    Driver = "SQLServer",
                    Server = "10.2.42.69",
                    UID = "kweons01",
                    PWD = "Pasword01#PasPasword01#Pas",
                    Port = 1433)     
hh_data_comp_raw <- dbGetQuery(con_hh, "SELECT * FROM qidm_dev.dbo.amb_hand_hygiene_comp")
hh_data_comp_raw <- as.data.frame(hh_data_comp_raw)

hh_data_comp_raw_pt_entry <- dbGetQuery(con_hh, "SELECT * FROM qidm_dev.dbo.PT_AMB_HAND_HYGIENE_COMP")
hh_data_comp_raw_pt_entry <- as.data.frame(hh_data_comp_raw_pt_entry)
# hh_data_comp_raw <- hh_data_comp_raw %>%
#   mutate_all(as.character) %>%
#   mutate(record_id = as.numeric(record_id),
#          unit_complete = as.numeric(unit_complete))



# write.csv(hh_data_comp_raw, "/nfs/data/Applications/Ambulatory/hh_crosswalk.csv", row.names=FALSE)

# hh_data_comp_raw_csv <-  as.data.frame(read_csv("/nfs/data/Applications/Ambulatory/hh_comp.csv"))
hh_crosswalk <- as.data.frame(read_csv("/nfs/data/Applications/Ambulatory/hh_crosswalk.csv"))
# hh_data_comp_raw_csv <-  as.data.frame(read_csv("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/hh_comp.csv"))
# hh_crosswalk <- as.data.frame(read_csv("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/hh_crosswalk.csv"))

 
```


```{r Radiology and Rad Onc Data, echo = FALSE, warning = FALSE, message = FALSE}
rad_onc_data_raw <- as.data.frame(read.csv("/nfs/data/Applications/Ambulatory/Rad_Onc_Data.csv"))
radiology_data_raw <- as.data.frame(read.csv("/nfs/data/Applications/Ambulatory/Radiology_Data.csv"))
radiology_ref <- as.data.frame(read.csv("/nfs/data/Applications/Ambulatory/Radiology_Site_Mapping.csv"))
# rad_onc_data_raw <- as.data.frame(read.csv("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/Rad_Onc_Data.csv"))
# radiology_data_raw <- as.data.frame(read.csv("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/Radiology_Data.csv"))
# radiology_ref <- as.data.frame(read.csv("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/Radiology_Site_Mapping.csv"))
# Process Radiology + Rad Onc Data
rad_onc_data_raw <- rad_onc_data_raw %>%
  mutate_at(c('MSBI', 'MSH.MSDFP', 'MSUS', 'MSW'), as.numeric) %>%
  mutate(Campus.Specialty = "Radiation Oncology",
         Department = "Radiation Oncology",
         Appt.Year = format(as.Date(as.yearmon(Month, "%y-%b"), format = "%b %y"),"%Y"),
         Appt.MonNum = as.numeric(format(as.Date(as.yearmon(Month, "%y-%b"), format = "%b %y"),"%m")),
         Appt.Month = format(as.Date(as.yearmon(Month, "%y-%b"), format = "%b %y"),"%b"),
         Visit.Method = "IN PERSON") %>%
  dplyr::select(-Month) %>%
  pivot_longer(MSBI:MSW,
               names_to = "Campus",
               values_to = "monthly_vol") %>%
  mutate(Campus = ifelse(Campus == "MSH.MSDFP","MSH-MSDFP",Campus))
# Process Radiology Data
radiology_data_raw[,2:length(radiology_data_raw)] <-lapply(radiology_data_raw[,2:length(radiology_data_raw)],as.numeric)
radiology_data_raw <- radiology_data_raw %>%
  pivot_longer(BC:UC,
               names_to = "Campus",
               values_to = "monthly_vol")
radiology_data_raw$Campus <- radiology_ref$Campus[match(radiology_data_raw$Campus, radiology_ref$ID)]
radiology_data_raw <- radiology_data_raw %>%
  group_by(Month, Campus) %>%
  summarise(monthly_vol = sum(monthly_vol)) %>%
  mutate(Campus.Specialty = "Radiology",
         Department = "Radiology",
         Appt.Year = format(as.Date(as.yearmon(Month, "%y-%b"), format = "%b %y"),"%Y"),
         Appt.MonNum = as.numeric(format(as.Date(as.yearmon(Month, "%y-%b"), format = "%b %y"),"%m")),
         Appt.Month = format(as.Date(as.yearmon(Month, "%y-%b"), format = "%b %y"),"%b"),
         Visit.Method = "IN PERSON") %>%
  dplyr::select(-Month) %>%
  arrange(Appt.Year, Appt.MonNum)
rad_radOnc_data <- bind_rows(rad_onc_data_raw, radiology_data_raw)
rad_radOnc_data <- rad_radOnc_data %>%
  mutate(Campus = toupper(Campus)) %>%
  filter(Campus %!in% c("OTHER", "MSQ", "MS NOW", "NYEE")) %>%
  filter(Appt.Year %in% c(format(as.Date(date_start),"%Y"),format(as.Date(date_end),"%Y"))) %>%
  group_by(Campus, Appt.Year, Appt.Month) %>%
  summarise(total = sum(monthly_vol)) %>%
  filter(Campus %in% inc_sites)
rad_onc_date <- paste0(rad_onc_data_raw[nrow(rad_onc_data_raw),"Appt.Month"],", ", rad_onc_data_raw[nrow(rad_onc_data_raw),"Appt.Year"])
radiology_date <- paste0(radiology_data_raw[nrow(radiology_data_raw),"Appt.Month"],", ", radiology_data_raw[nrow(radiology_data_raw),"Appt.Year"])
```


```{r Hand Hygiene Data Processing, echo = FALSE, warning = FALSE, message = FALSE}
colnames(hh_data_comp_raw) <- tolower(colnames(hh_data_comp_raw))
# colnames(hh_data_comp_raw)[which(colnames(hh_data_comp_raw) == "data_date")] <- "date"
# Map MSD units
hh_data_comp_raw$site<- ifelse(hh_data_comp_raw$site == "MSD",
                                hh_crosswalk$unit[match(hh_data_comp_raw$msd_unit, hh_crosswalk$Location)], hh_data_comp_raw$site)
# Map msh_unit
hh_data_comp_raw$site<- ifelse(hh_data_comp_raw$site == "MSH",
                                hh_crosswalk$unit[match(hh_data_comp_raw$msh_unit, hh_crosswalk$Location)], hh_data_comp_raw$site)
hh_data_comp <- hh_data_comp_raw %>%
  dplyr::select(-language) %>%
  pivot_longer(
    c("msb_unit","msh_unit","msd_unit","nyee_unit","msq_unit","msm_unit","msw_unit","net_unit"),
    names_to = "unit_site",
    values_to = "unit"
  ) %>%
  filter(date != "NULL") %>%
  mutate_if(is.numeric, as.character) %>%
  filter(!is.na(site))


# Process patient entered data -------------------------------------------------
colnames(hh_data_comp_raw_pt_entry) <- tolower(colnames(hh_data_comp_raw_pt_entry))
hh_data_comp_pt_entry <- hh_data_comp_raw_pt_entry %>%
  rename(date = data_date) %>%
  mutate_if(is.numeric, as.character) 

hh_data_comp_pt_entry$date <- as.character(hh_data_comp_pt_entry$date)


hh_data_comp <- bind_rows(hh_data_comp, hh_data_comp_pt_entry)



# datatable(hh_data_comp, extensions = "Buttons", 
#             options = list(paging = TRUE,
#                            scrollX=TRUE, 
#                            searching = TRUE,
#                            ordering = TRUE,
#                            dom = 'Bfrtip',
#                            buttons = c('copy', 'csv', 'excel', 'pdf'),
#                            pageLength=5, 
#                            lengthMenu=c(3,5,10) ))

hh_data_merged <- hh_data_comp %>%
  filter(!site %in% c("MS NOW", "MSHP", "NYEE", "MSQ","OTHER","MSB")) %>%
  filter(!is.na(site)) %>%
  select(site, unit, date, worker___1, worker___2, worker___3, provider_hands_bef, provider_hands_aft, nurse_hands_bef, nurse_hands_aft, mt_hands_bef, mt_hands_aft) %>%
  mutate(across(4:12, as.numeric)) %>%
  mutate_if(is.numeric, ~ifelse(is.na(.),0,.)) %>%
  mutate_if(is.numeric, ~ifelse(.==2,0,.)) %>%
  group_by(site, unit, date) %>%
  summarise(worker___1 = sum(worker___1),
            worker___2 = sum(worker___2),
            worker___3 = sum(worker___3),
            provider_hands_bef = sum(provider_hands_bef),
            provider_hands_aft = sum(provider_hands_aft),
            nurse_hands_bef = sum(nurse_hands_bef),
            nurse_hands_aft = sum(nurse_hands_aft),
            mt_hands_bef = sum(mt_hands_bef),
            mt_hands_aft = sum(mt_hands_aft)) %>%
  mutate(date = as.Date(date, "%Y-%m-%d"),
         Appt.Year = as.numeric(format(as.Date(date, "%Y-%m-%d"),"%Y")),
         Appt.WeekNum = lubridate::epiweek(as.Date(date, "%Y-%m-%d")))
hh_data_merged_role <- hh_data_comp %>%
  filter(!site %in% c("MS NOW", "MSHP", "NYEE", "MSQ","OTHER")) %>%
  filter(!is.na(site)) %>%
  select(site, unit, date, provider_hands_bef, provider_hands_aft, nurse_hands_bef, nurse_hands_aft, mt_hands_bef, mt_hands_aft) %>%
  pivot_longer(provider_hands_bef: mt_hands_aft,
               names_to = "role",
               values_to = "compliance") %>%
  mutate(date = as.Date(date, "%Y-%m-%d"),
         Appt.Year = as.numeric(format(as.Date(date, "%Y-%m-%d"),"%Y")),
         Appt.WeekNum = lubridate::epiweek(as.Date(date, "%m/%d/%Y")),
         compliance = ifelse(compliance == 2,0,compliance)) %>%
  filter(compliance != "") %>%
# filter(!is.na(compliance)) %>%
  filter(compliance != 2) %>%
  group_by(site, unit, date, Appt.Year, Appt.WeekNum, role, compliance) %>%
  summarise(total_obs = n())%>%
  mutate(compliance = ifelse(compliance == 0, "No", "Yes"),
         total_obs = as.numeric(total_obs)) %>%
  pivot_wider(
    names_from = compliance,
    values_from = total_obs,
    values_fill=list(total_obs=0)) %>%
    mutate(total_obs = Yes + No)
  

# datatable(hh_data_merged_role, extensions = "Buttons", 
#             options = list(paging = TRUE,
#                            scrollX=TRUE, 
#                            searching = TRUE,
#                            ordering = TRUE,
#                            dom = 'Bfrtip',
#                            buttons = c('copy', 'csv', 'excel', 'pdf'),
#                            pageLength=5, 
#                            lengthMenu=c(3,5,10) ))



# str(hh_data_merged_role)

# # Change NET to NETWORK
hh_data_merged <- hh_data_merged %>%
  mutate(site = ifelse(site == "NET","NETWORK",site)) %>%
  arrange(date) %>%
  filter(unit != "NULL")
hh_data_merged_role <- hh_data_merged_role %>%
  mutate(site = ifelse(site == "NET","NETWORK",site)) %>%
  arrange(date) %>%
  filter(unit != "NULL")
hh_data_merged <- hh_data_merged %>%
  mutate(site = ifelse(unit == "UCC", "MSUS",site))

```



```{r Data ExportinG csv, echo = FALSE, warning = FALSE, message = FALSE}
# vol_2021_export <- scheduling_data_raw_2 %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.Year == "2021") %>%
#   group_by(Campus, Department, Appt.Year) %>%
#   summarise(`2021 Completed Visits` = n())
#
# monthly_vol_2021_export <-  scheduling_data_raw_2 %>%
#   filter(Appt.Status == "Arrived") %>%
#   group_by(Campus, Department, Appt.MonthYear) %>%
#   summarise(`2021 Completed Visits` = n()) %>%
#   pivot_wider(
#     names_from = Appt.MonthYear,
#     values_from = '2021 Completed Visits'
#   )
#
# write_csv(vol_2021_export, "2021 Ambulatory Volume.csv")
# write_csv(monthly_vol_2021_export, "YTD Monthly Ambulatory Volume.csv")
#
# check <- scheduling_data_raw_2 %>%
#   filter(Appt.Status == "Arrived") %>%
#   group_by(Campus, Appt.MonthYear) %>%
#   summarise(`2021 Completed Visits` = n())
```


```{r Set Variables, echo = FALSE, warning = FALSE, message = FALSE}
# Set up crosswalk for Week Number and Week Starting Date (Monday)
# weekNum_monday <- scheduling_data_raw %>%
#   filter(Appt.DateYear >= date_start, Appt.DateYear <= date_end) %>%
#   filter(Appt.Day == "Mon") %>%
#   mutate(Appt.WeekNum = as.numeric(strftime(Appt.DateYear, format = "%V"))) %>%
#   select(Appt.Year, Appt.WeekNum, Appt.Day, Appt.DateYear) %>%
#   distinct() %>%
#   arrange(Appt.DateYear)
# # weekNum_monday <- tail(weekNum_monday, 58)
#
# # Set Variables
# report_run_date <- Sys.time()
#
# todays_date <- (tail(weekNum_monday,1))$Appt.DateYear
# todays_year <- strftime(todays_date, format = "%Y")
# todays_week <- as.numeric(strftime(todays_date, format = "%V"))
# past_4_wks <- tail(weekNum_monday, 4)
# past_5_wks <- tail(weekNum_monday, 5)
# past_year <- weekNum_monday %>%
#   filter(Appt.WeekNum %in% unique(past_5_wks$Appt.WeekNum))
#
# reporting_week <- as.Date(paste(todays_year, todays_week, 1, sep="-"), "%Y-%U-%u")
weekNum_sunday <- scheduling_data_raw %>%
  filter(Appt.DateYear >= date_start, Appt.DateYear <= date_end) %>%
  filter(Appt.Day == "Sun") %>%
  mutate(Appt.WeekNum = lubridate::epiweek(Appt.DateYear)) %>%
  dplyr::select(Appt.Year, Appt.WeekNum, Appt.Day, Appt.DateYear) %>%
  distinct() %>%
  arrange(Appt.DateYear)
# weekNum_sunday <- head(weekNum_sunday, -1)
# Set Variables
report_run_date <- Sys.Date()
todays_date <- (tail(weekNum_sunday,1))$Appt.DateYear
todays_year <- strftime(todays_date, format = "%Y")
todays_week <- (tail(weekNum_sunday,1))$Appt.DateYear
past_4_wks <- tail(weekNum_sunday, 4)
past_5_wks <- tail(weekNum_sunday, 5)
past_year <- weekNum_sunday %>%
  filter(Appt.WeekNum %in% unique(past_5_wks$Appt.WeekNum))
reporting_week <- paste0("from Sunday, ",todays_date, " to Saturday, ",todays_date+6)
```


```{r Data Processing, echo = FALSE, warning = FALSE, message = FALSE}
# Scheduling Data
scheduling_data <- scheduling_data_raw %>%
  filter(!Campus %in% c("MSB", "MS NOW", "MSHP", "NYEE", "MSQ","OTHER","INPATIENT")) %>%
  filter(!is.na(Campus))
  
rm(scheduling_data_raw)
invisible(gc())

scheduling_data <- scheduling_data %>%
  mutate(Appt.WeekNum = lubridate::epiweek(Appt.DateYear),
         Visit.Method  = case_when(Visit.Method == "IN PERSON" ~ 'IN PERSON',TRUE ~ 'TELEHEALTH'),
         New.PT2 = case_when(New.PT2 == "New" ~ 'New', TRUE ~ 'Established'),
         New.PT3 = case_when(New.PT3 == "TRUE" ~ 'New',TRUE ~ 'Established'),
         enc.status = case_when(ENC_CLOSED_CHARGE_STATUS %in% c("OPEN", "CLOSED BUT COSIGN NEEDED") ~ 'OPEN',TRUE ~ 'CLOSED'),
         open.hours = ifelse(enc.status == "OPEN",
                             as.numeric(round(difftime(max(date_end)+1, Appt.DTTM, units = "hours"))),
                             as.numeric(round(difftime(Y_ENC_CLOSE_TIME, Appt.DTTM, units = "hours")))),
         open.days = round(open.hours/24)) %>%
   mutate(Appt.Made.DateYear = as.Date(Appt.Made.DTTM, format="%Y-%m-%d"),
          Appt.Made.MonthYear = format(as.Date(Appt.Made.DTTM, format="%m/%d/%Y"), "%Y-%m"),
          Appt.Made.Year = format(as.Date(Appt.Made.DTTM, format="%m/%d/%Y"), "%Y"),
          Appt.Made.WeekNum = as.numeric(strftime(Appt.Made.DTTM, format = "%V")))

# Missing Charges (Update when mater data is re-processed)
business_days <- seq(date_start, date_end, by="days")[!is.weekend(seq(date_start, date_end, by="days"))]
missing_chg_cutOff <- business_days[length(business_days)-3] # Should this be 2 or 3?
```


```{r Epic Department Mapping Processing, echo = FALSE, warning = FALSE, message = FALSE}
epic_depts <- scheduling_data %>%
  group_by(Campus, Campus.Specialty, Department) %>%
  summarise(total = n()) %>%
  dplyr::select(-total) %>%
  arrange(Campus, Campus.Specialty, Department)
epic_depts_site <- function(site){

  epic_depts %>%
    filter(Campus == site) %>%
    select(everything()) %>%
    kable(escape = F, align = "l") %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE, position = "center", row_label_position = "c", font_size = 14) %>%
    add_header_above(c("Epic Department Mapping" = length(epic_depts)),
                     background = "#221f72", color = "white", font_size = 14) %>%
    column_spec(1:2, width = "300px") %>%
    collapse_rows(1:2, valign="top")
}

invisible(gc())
```


```{r Volume Metrics Data, echo = FALSE, warning = FALSE, message = FALSE}
# Volume Data
vol_past_month <- scheduling_data %>%
  filter(Appt.Status == "Arrived") %>%
  filter(Appt.DateYear >= date_start, Appt.DateYear <= date_end) %>%
  filter(Appt.WeekNum %in% unique(past_year$Appt.WeekNum)) %>%
  arrange(Appt.Year, Appt.WeekNum) %>%
  group_by(Campus, Campus.Specialty, Department, Appt.Year, Appt.WeekNum, Visit.Method) %>%
  summarise(weekly_vol = n()) %>%
  pivot_wider(
    names_from = Visit.Method,
    values_from = weekly_vol,
    values_fill=list(weekly_vol=0)
  ) %>%
  mutate(Total = sum(`IN PERSON`, TELEHEALTH)) %>%
  pivot_longer(
    6:8,
    names_to = "Visit.Method",
    values_to = "weekly_vol"
  ) %>%
  mutate(Appt.WeekNum = as.numeric(Appt.WeekNum))
invisible(gc())

```


```{r Primary Care Time to Appointment Data, echo = FALSE, warning = FALSE, message = FALSE}
# Time to Appointment
# time_to_appt_all <- merge(past_year_data, past_4_wks[,c("Appt.Year","Appt.WeekNum")])
# time_to_appt_all <- scheduling_data %>%
#   # mutate(Appt.Made.DateYear = as.Date(Appt.Made.DTTM, format="%Y-%m-%d"),
#   #       Appt.Made.MonthYear = format(as.Date(Appt.Made.DTTM, format="%m/%d/%Y"), "%Y-%m"),
#   #       Appt.Made.Year = format(as.Date(Appt.Made.DTTM, format="%m/%d/%Y"), "%Y"),
#   #       Appt.Made.WeekNum = as.numeric(strftime(Appt.Made.DTTM, format = "%V"))) %>%
#   filter(Appt.Made.Year %in% unique(past_4_wks$Appt.Year)) %>%
#   filter(Appt.Made.WeekNum %in% unique(past_4_wks$Appt.WeekNum)) %>%
#   filter(Campus.Specialty %in% c("Internal Medicine", "Family Medicine")) %>%
#   # mutate(Wait.Time = as.numeric(round(difftime(Appt.DTTM, Appt.Made.DTTM,  units = "days")))) %>%
#   filter(Wait.Time >= 0) %>%
#   # filter(!is.na(New.PT2)) %>%
#   # mutate(New.PT2 = case_when(New.PT2 == "TRUE" ~ 'New'
#   #                                  ,TRUE ~ 'Established')) %>%
#   mutate(Wait.Time = as.numeric(Wait.Time))
```


```{r No Show Data, echo = FALSE, warning = FALSE, message = FALSE}
# No Show Data
# no_show_rate <- merge(past_year_data, past_4_wks[,c("Appt.Year","Appt.WeekNum")])
# no_show_rate <- scheduling_data %>%
#   filter(Appt.Year %in% unique(past_4_wks$Appt.Year)) %>%
#   filter(Appt.WeekNum %in% unique(past_4_wks$Appt.WeekNum)) %>%
#   filter(Appt.Status %in% c("Arrived","No Show")) %>%
#   arrange(Appt.Year, Appt.WeekNum) %>%
#   group_by(Campus, Campus.Specialty, Department, Appt.Year, Appt.WeekNum, Visit.Method, Appt.Status) %>%
#   summarise(weekly_vol = n()) %>%
#   mutate(Appt.WeekNum = as.numeric(Appt.WeekNum))
```


```{r Sinai Logo, echo=FALSE, out.width = '30%'}
knitr::include_graphics("Mount_Sinai_Logo_H.png")
```


```{r}
# 
# missing_chg_data <- scheduling_data %>%
#   filter(Appt.Year == "2022") %>%
#   filter(Department %!in% unique(missing_exc_dept$DEPARTMENT)) %>%
#   filter(Provider %!in% unique(missing_exc_resource$PROVIDER)) %>%
#   # filter(Department %!in% unique(missing_exc_dept$DEPARTMENT)) %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Resource == "Provider") %>%
#   mutate(visit_exclude = case_when(str_detect(Appt.Type, "ECHO|SOCIAL|NURSE|NUTRITION|LAB|TREATMENT") ~ "YES"
#                                          ,TRUE ~ "NO")) %>%
#   filter(visit_exclude == "NO") 
# 
# missing_chg_data_msm <- missing_chg_data %>%
#   filter(Campus == "MSM")
# 
# write_xlsx(missing_chg_data_msm,"missing_chg_data_msm.xlsx")
# 
# 
# missing_chg_data_msm_trend <- missing_chg_data_msm %>%
#   filter(Appt.DateYear >= date_start, Appt.DateYear <= missing_chg_cutOff) %>%
#   # filter(enc.status == "CLOSED") %>%
#   mutate(clo.7days = case_when(open.days <= 7 ~ 'YES', TRUE ~ 'NO')) %>%
#   group_by(Campus, Appt.MonthYear, enc.status, clo.7days) %>%
#   summarise(total = n()) %>%
#    group_by(Campus, Appt.MonthYear) %>%
#   mutate(total.enc = sum(total)) %>%
#   pivot_wider(names_from = clo.7days,
#               values_from = total,
#               values_fill = 0) %>%
#   mutate(clo.7days.perc = round((YES/(total.enc))*100,0)) %>%
#   filter(enc.status == "CLOSED")

```

# System Huddle Ambulatory Report
*Report run date: `r report_run_date`*<br/>
*Report produced for week of `r reporting_week`*<br/>
*Rad Onc and Radiology data is included only in monthly volumes.*<br/>
*A Full week is comprised of Sunday to Saturday.*<br/>
*Data excludes eIDX, MD Office data.*<br/>
________________________________________________________________________________________________________________________________________________
<br/>

## Metrics Overview
### 1.Open Encounters Trending

```{r Open Encounters Metric Trending by Site, fig.width=12, fig.height = 5, fig.align = 'center', echo = FALSE, warning = FALSE, message = FALSE}
site_cols <- c("#212070","#d80b8c","#00aeef","#7f7f7f","#ffc000","#7030a0","#c7c6ef","#fcc9e9","#c9f0ff","#dddedd")
# Import in exclusion criteria
# Exclude ECHO encounters
missing_exc_dept <- read_excel("/nfs/data/Applications/Ambulatory/open_encounters_exclusion_dept.xlsx")
missing_exc_resource <- read_excel("/nfs/data/Applications/Ambulatory/open_encounters_exclusion_res.xlsx")
missing_exc_visitType <- read_excel("/nfs/data/Applications/Ambulatory/open_encounters_exclusion_visit.xlsx")
# missing_exc_dept <- read_excel("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/open_encounters_exclusion_dept.xlsx")
# missing_exc_resource <- read_excel("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/open_encounters_exclusion_res.xlsx")
# missing_exc_visitType <- read_excel("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/open_encounters_exclusion_visit.xlsx")
# Based on Metric % Encounters Closed within 7 days
# Missing Charges Trending by Site
# missing_chg_data_trend <- scheduling_data %>%
#   filter(Appt.Year == 2022) %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Resource == "Provider") %>%
#   filter(Appt.DateYear <= missing_chg_cutOff) %>%
#    mutate(clo.7days = case_when(open.days <= 7 ~ 'YES', TRUE ~ 'NO')) %>%
#   # filter(Appt.DateYear >= as.Date("2021-06-01", "%Y-%m-%d")) %>%
#   filter(Department %!in% unique(missing_exc_dept$DEPARTMENT)) %>%
#   filter(Provider %!in% unique(missing_exc_resource$PROVIDER)) %>%
#   mutate(visit_exclude = case_when(str_detect(Appt.Type, "ECHO|SOCIAL|NURSE|NUTRITION|LAB|TREATMENT") ~ "YES"
#                                          ,TRUE ~ "NO")) %>%
#   filter(visit_exclude == "NO") %>%
#   # filter(enc.status == "CLOSED") %>%
#   group_by(Campus, Appt.MonthYear, enc.status, clo.7days) %>%
#   summarise(total = n()) %>%
#    group_by(Campus, Appt.MonthYear) %>%
#   mutate(total.enc = sum(total)) %>%
#   pivot_wider(names_from = clo.7days,
#               values_from = total,
#               values_fill = 0) %>%
#   mutate(clo.7days.perc = round((YES/(total.enc))*100,0)) %>%
#   filter(enc.status == "CLOSED")
# 
# invisible(gc())

missing_chg_data_trend <- as.data.frame(readRDS("/nfs/data/Applications/Ambulatory/Data_Updated/missing_chg_data_trend.rds")) 
```


```{r Open Encounters Metric Trending by Site Output, fig.width=12, fig.height = 5, fig.align = 'center', echo = FALSE, warning = FALSE, message = FALSE}
# Total Encounters and % Closed within 7 Days by Site
map(unique(missing_chg_data_trend$Campus), function(x){
highchart() %>%
  hc_yAxis_multiples(
    list(title = list(text = "Total Encounters"), lineWidth = 3),
    list(title = list(text = "% of Encounters"), showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (missing_chg_data_trend %>% filter(Campus == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%m/%d}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name = "Total Encounters",
                data = (missing_chg_data_trend %>% filter(Campus == x))$total.enc,
                type = 'column',
                color='#212070',
                dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name = "% Encounters Closed <=7 Days",
                data = (missing_chg_data_trend %>% filter(Campus == x))$clo.7days.perc,
                type = "line", yAxis = 1,
                color='#d80b8c',
                lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}%')) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0(x, " - % Encounters Closed <=7 Days"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = paste0("Excludes Radiology and Rad Onc visits <br>",
                            "Includes Epic provider visits only <br>",
                            "Based on visits from ",date_start," to ",missing_chg_cutOff),
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
  hc_tooltip(shared = TRUE, borderColor = "black")
}) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()
# # Based on Metric % Encounters Open > 7 days
# # Missing Charges Trending by Site
# missing_chg_data_trend <- scheduling_data %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Appt.DateYear >= date_start, Appt.DateYear <= missing_chg_cutOff) %>%
#   # filter(Appt.DateYear <= missing_chg_cutOff) %>%
#   # filter(enc.status == "CLOSED") %>%
#   mutate(open.7days = case_when(open.days > 7 ~ 'YES', TRUE ~ 'NO')) %>%
#   group_by(Campus, Appt.MonthYear, open.7days) %>%
#   summarise(total = n()) %>%
#   pivot_wider(names_from = open.7days,
#               values_from = total,
#               values_fill = 0) %>%
#   mutate(total.enc = YES + NO,
#          open.7days.perc = round((YES/(total.enc))*100,0))
#
# missing_chg_data_trend_downtown <- scheduling_data %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Campus %in% c("MSUS","MSDD","MSBI")) %>%
#   mutate(Campus = "MS Downtown") %>%
#   filter(Appt.DateYear >= date_start, Appt.DateYear <= missing_chg_cutOff) %>%
#   # filter(Appt.DateYear <= missing_chg_cutOff) %>%
#   # filter(enc.status == "CLOSED") %>%
#   mutate(open.7days = case_when(open.days > 7 ~ 'YES', TRUE ~ 'NO')) %>%
#   group_by(Campus, Appt.MonthYear, open.7days) %>%
#   summarise(total = n()) %>%
#   pivot_wider(names_from = open.7days,
#               values_from = total,
#               values_fill = 0) %>%
#   mutate(total.enc = YES + NO,
#          open.7days.perc = round((YES/(total.enc))*100,0))
#
#
# # Total Encounters and % Closed within 7 Days by Site
# map(unique(missing_chg_data_trend$Campus), function(x){
# highchart() %>%
#   hc_yAxis_multiples(
#     list(title = list(text = "Total Encounters"), lineWidth = 3),
#     list(title = list(text = "% of Encounters"), showLastLabel = FALSE, opposite = TRUE)
#   ) %>%
#   hc_xAxis(title = list(text = ""),
#            categories = missing_chg_data_trend$Appt.MonthYear,
#            type = "datetime",
#            labels = list(format = '{value:%m/%d}')
#            # dateTimeLabelFormats = list(month = '%Y-%m')
#            ) %>%
#   hc_add_series(name = "Total Encounters",
#                 data = (missing_chg_data_trend %>% filter(Campus == x))$total.enc,
#                 type = 'column',
#                 color='#212070',
#                 dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
#   hc_add_series(name = "% Encounters Open >7 Days",
#                 data = (missing_chg_data_trend %>% filter(Campus == x))$open.7days.perc,
#                 type = "line", yAxis = 1,
#                 color='#d80b8c',
#                 lineColor='#d80b8c',
#                 dataLabels = list(enabled = TRUE, format='{point.y}%')) %>%
#   hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
#   hc_title(text = paste0(x, " - % Encounters Open >7 Days"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
#   hc_subtitle(text = paste0("Excludes Radiology and Rad Onc visits <br>","Based on visits from ",date_start," to ",missing_chg_cutOff),
#               align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
#   hc_tooltip(shared = TRUE, borderColor = "black")
# }) %>%
#   hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

invisible(gc())

```

--------------------------------------------------------------------------------
```{r Open Encounters Metric Trending Summarized, fig.width=12, fig.height = 5, fig.align = 'center', echo = FALSE, warning = FALSE, message = FALSE}


# missing_chg_data_trend_downtown <- scheduling_data %>%
#    filter(Department %!in% unique(missing_exc_dept$DEPARTMENT)) %>%
#   filter(Provider %!in% unique(missing_exc_resource$PROVIDER)) %>%
#   filter(Appt.Status == "Arrived") %>%
#   filter(Resource == "Provider") %>%
#   mutate(visit_exclude = case_when(str_detect(Appt.Type, "ECHO|SOCIAL|NURSE|NUTRITION|LAB|TREATMENT") ~ "YES"
#                                          ,TRUE ~ "NO")) %>%
#   filter(visit_exclude == "NO") %>%
#   filter(Campus %in% c("MSUS","MSDD","MSBI")) %>%
#   mutate(Campus = "MS Downtown") %>%
#   filter(Appt.DateYear >= date_start, Appt.DateYear <= missing_chg_cutOff) %>%
#   # filter(Appt.DateYear <= missing_chg_cutOff) %>%
#   # filter(enc.status == "CLOSED") %>%
#   mutate(clo.7days = case_when(open.days <= 7 ~ 'YES', TRUE ~ 'NO')) %>%
#   group_by(Campus, Appt.MonthYear, enc.status, clo.7days) %>%
#   summarise(total = n()) %>%
#    group_by(Campus, Appt.MonthYear) %>%
#   mutate(total.enc = sum(total)) %>%
#   pivot_wider(names_from = clo.7days,
#               values_from = total,
#               values_fill = 0) %>%
#   mutate(clo.7days.perc = round((YES/(total.enc))*100,0)) %>%
#   filter(enc.status == "CLOSED")

missing_chg_data_trend_downtown <- as.data.frame(readRDS("/nfs/data/Applications/Ambulatory/Data_Updated/missing_chg_data_trend_downtown.rds")) 

invisible(gc())

# Based on Metric % Encounteres Closed <=7 days
map(unique(missing_chg_data_trend_downtown$Campus), function(x){
highchart() %>%
  hc_yAxis_multiples(
    list(title = list(text = "Total Encounters"), lineWidth = 3),
    list(title = list(text = "% of Encounters"), showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = missing_chg_data_trend_downtown$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%m/%d}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name = "Total Encounters",
                data = (missing_chg_data_trend_downtown %>% filter(Campus == x))$total.enc,
                type = 'column',
                color='#212070',
                dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name = "% Encounters Closed <=7 Days",
                data = (missing_chg_data_trend_downtown %>% filter(Campus == x))$clo.7days.perc,
                type = "line", yAxis = 1,
                color='#d80b8c',
                lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}%')) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0(x, " - % Encounters Closed <=7 Days"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = paste0("Includes MSUS, MSDD, and MSBI <br>",
                            "Includes Epic provider visits only <br>",
                            "Excludes Radiology and Rad Onc visits <br>", "Based on visits from ",date_start," to ",missing_chg_cutOff),
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
  hc_tooltip(shared = TRUE, borderColor = "black")
}) %>%
  hw_grid(ncol = 2, rowheight = 450) %>% htmltools::browsable()
# # Based on Metric % Encounteres Open >7 days
# map(unique(missing_chg_data_trend_downtown$Campus), function(x){
# highchart() %>%
#   hc_yAxis_multiples(
#     list(title = list(text = "Total Encounters"), lineWidth = 3),
#     list(title = list(text = "% of Encounters"), showLastLabel = FALSE, opposite = TRUE)
#   ) %>%
#   hc_xAxis(title = list(text = ""),
#            categories = missing_chg_data_trend_downtown$Appt.MonthYear,
#            type = "datetime",
#            labels = list(format = '{value:%m/%d}')
#            # dateTimeLabelFormats = list(month = '%Y-%m')
#            ) %>%
#   hc_add_series(name = "Total Encounters",
#                 data = (missing_chg_data_trend_downtown %>% filter(Campus == x))$total.enc,
#                 type = 'column',
#                 color='#212070',
#                 dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
#   hc_add_series(name = "% Encounters Open >7 Days",
#                 data = (missing_chg_data_trend_downtown %>% filter(Campus == x))$open.7days.perc,
#                 type = "line", yAxis = 1,
#                 color='#d80b8c',
#                 lineColor='#d80b8c',
#                 dataLabels = list(enabled = TRUE, format='{point.y}%')) %>%
#   hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
#   hc_title(text = paste0(x, " - % Encounters Open >7 Days"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
#   hc_subtitle(text = paste0("Includes MSUS, MSDD, and MSBI <br>","Excludes Radiology and Rad Onc visits <br>", "Based on visits from ",date_start," to ",missing_chg_cutOff),
#               align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
#   hc_tooltip(shared = TRUE, borderColor = "black")
# }) %>%
#   hw_grid(ncol = 2, rowheight = 450) %>% htmltools::browsable()

rm(missing_chg_data_trend)
rm(missing_chg_data_trend_downtown)
invisible(gc())
```

### 2. Visit Volume Variance Trending
```{r Volume Variance to 2019 Metric Trending by Site, echo = FALSE, warning = FALSE, message = FALSE}
monthOptions <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")
vol_trending <- scheduling_data %>%
  filter(Appt.Status == "Arrived") %>%
  filter(Appt.DateYear >= date_start, Appt.DateYear <= date_end) %>%
  group_by(Campus, Appt.Year, Appt.Month) %>%
  summarise(total = n())
# Merge with radiology and rad onc monthly volume
vol_trending <- bind_rows(vol_trending, rad_radOnc_data)
vol_trending <- vol_trending %>%
  group_by(Campus, Appt.Year, Appt.Month) %>%
  summarise(total = sum(total)) %>%
  pivot_wider(names_from = Appt.Year,
              values_from = total) %>%
  # mutate(target_5_perc = round(`2021`*1.05)) %>%
  arrange(factor(Appt.Month, levels = monthOptions)) %>%
  arrange(Campus) %>%
  mutate(perc_change = round(((`2022` - `2021`)/`2021`)*100, 0))
map(unique(vol_trending$Campus), function(x){
highchart() %>%
  hc_yAxis_multiples(
    list(title = list(text = "Total Visits"), lineWidth = 3, min = 0),
    list(title = list(text = "% Change from Prior Year"), min = -50,max=200,
           labels = list(format = '{value}%'),
           showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (vol_trending %>% filter(Campus == x))$Appt.Month,
           type = "datetime",
           labels = list(format = '{value:%m/%d}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name   = "2021 Total Visits",
                data   = (vol_trending %>% filter(Campus == x))$`2021`,
                # type = 'column',
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#a5a7a5',
                lineWidth=3,
                lineColor='#a5a7a5'
                ) %>%
  hc_add_series(name = "2022 Total Visits",
                data   = (vol_trending %>% filter(Campus == x))$`2022`,
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name = "% Change from Prior Year",
                data = (vol_trending %>% filter(Campus == x))$perc_change,
                type = "column", yAxis = 1,
                                zones = list(list(value = 0,
                                  color = 'red')),
                color='#00b800',
                # lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}%')) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
    hc_title(text = paste0(x, " - Visit Volume Variance"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
    hc_subtitle(text = paste0("Includes Radiology and Rad Onc visits up to ",radiology_date,"<br> Based on visits from ",date_start," to ",date_end),
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```

--------------------------------------------------------------------------------
```{r Volume Variance to 2019 Metric Trending Summarized, echo = FALSE, warning = FALSE, message = FALSE}
vol_trending_downtown <- vol_trending %>%
  filter(Campus %in% c("MSUS","MSDD","MSBI")) %>%
  mutate(Campus = "MS Downtown") %>%
  dplyr::select(-perc_change) %>%
  pivot_longer(3:4,
               names_to = "Appt.Year",
               values_to = "total") %>%
  group_by(Campus, Appt.Year, Appt.Month) %>%
  summarise(total = sum(total)) %>%
  pivot_wider(names_from = Appt.Year,
              values_from = total) %>%
  # mutate(target_5_perc = round(`2021`*1.05)) %>%
  arrange(factor(Appt.Month, levels = monthOptions)) %>%
  arrange(Campus) %>%
  mutate(perc_change = round(((`2022` - `2021`)/`2021`)*100, 0))
map(unique(vol_trending_downtown$Campus), function(x){
highchart() %>%
  hc_yAxis_multiples(
    list(title = list(text = "Total Visits"), lineWidth = 3, min = 0),
    list(title = list(text = "% Change from Prior Year"), min = -50,max=200,
           labels = list(format = '{value}%'),
           showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (vol_trending_downtown %>% filter(Campus == x))$Appt.Month,
           type = "datetime",
           labels = list(format = '{value:%m/%d}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name   = "2021 Total Visits",
                data   = (vol_trending_downtown %>% filter(Campus == x))$`2021`,
                # type = 'column',
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#a5a7a5',
                lineWidth=3,
                lineColor='#a5a7a5'
                ) %>%
  hc_add_series(name = "2022 Total Visits",
                data   = (vol_trending_downtown %>% filter(Campus == x))$`2022`,
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name = "% Change from Prior Year",
                data = (vol_trending_downtown %>% filter(Campus == x))$perc_change,
                type = "column", yAxis = 1,
                                zones = list(list(value = 0,
                                  color = 'red')),
                color='#00b800',
                # lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}%')) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
    hc_title(text = paste0(x, " - Visit Volume Variance"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
    hc_subtitle(text = paste0("Includes MSUS, MSDD, and MSBI <br>","Includes Radiology and Rad Onc visits up to ",radiology_date,
                              "<br> Based on visits from ",date_start," to ",date_end),
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 450) %>% htmltools::browsable()


rm(vol_trending)
rm(vol_trending_downtown)
invisible(gc())
```

### 3. New Patient Ratio Trending
```{r New Patient Volume Trending by Site, echo = FALSE, warning = FALSE, message = FALSE}
new_vol_trending <- scheduling_data %>%
  filter(Appt.Status == "Arrived") %>%
  filter(Appt.Year == 2022) %>%
  filter(Appt.DateYear <= date_end) %>%
  # filter(Appt.DateYear >= date_start, Appt.DateYear <= date_end) %>%
  # mutate(New.PT2 = ifelse(New.PT2 == "",FALSE,New.PT2)) %>%
  group_by(Campus, Appt.MonthYear, New.PT2) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = New.PT2,
              values_from = total) %>%
  mutate(total_vol = New + Established,
         new_perc = round((New/(total_vol))*100,0))
map(unique(new_vol_trending$Campus), function(x){
highchart() %>%
  hc_yAxis_multiples(
    list(title = list(text = "Total Visits"), lineWidth = 3),
    list(title = list(text = "% of New Visits"), labels = list(format = '{value}%'),
         showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (new_vol_trending %>% filter(Campus == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%m/%d}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name = "Total Visits",
                data = (new_vol_trending %>% filter(Campus == x))$total_vol,
                type = 'column',
                color='#212070',
                dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name = "% New Visits",
                data = (new_vol_trending %>% filter(Campus == x))$new_perc,
                type = "line", yAxis = 1,
                color='#d80b8c',
                lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}%')) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0(x, " - % New Visits"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = paste0("Excludes Radiology and Rad Onc visits <br>", "Based on visits from 2022-01-01"," to ",date_end),
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
  hc_tooltip(shared = TRUE, borderColor = "black")
}) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()
```

--------------------------------------------------------------------------------
```{r New Patient Volume Trending Summarized, echo = FALSE, warning = FALSE, message = FALSE}
new_vol_trending_downtown <- scheduling_data %>%
  filter(Appt.Status == "Arrived") %>%
  filter(Campus %in% c("MSUS","MSDD","MSBI")) %>%
  mutate(Campus = "MS Downtown") %>%
  filter(Appt.Year == 2022) %>%
  filter(Appt.DateYear <= date_end) %>%
  # filter(Appt.DateYear >= date_start, Appt.DateYear <= date_end) %>%
  # mutate(New.PT2 = ifelse(New.PT2 == "",FALSE,New.PT2)) %>%
  group_by(Campus, Appt.MonthYear, New.PT2) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = New.PT2,
              values_from = total) %>%
  mutate(total_vol = New + Established,
         new_perc = round((New/(total_vol))*100,0))
map(unique(new_vol_trending_downtown$Campus), function(x){
highchart() %>%
  hc_yAxis_multiples(
    list(title = list(text = "Total Visits"), lineWidth = 3),
    list(title = list(text = "% of New Visits"), labels = list(format = '{value}%'),
         showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (new_vol_trending_downtown %>% filter(Campus == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%m/%d}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name = "Total Visits",
                data = (new_vol_trending_downtown %>% filter(Campus == x))$total_vol,
                type = 'column',
                color='#212070',
                dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name = "% New Visits",
                data = (new_vol_trending_downtown %>% filter(Campus == x))$new_perc,
                type = "line", yAxis = 1,
                color='#d80b8c',
                lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}%')) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0(x, " - % New Visits"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = paste0("Excludes Radiology and Rad Onc visits <br>", "Based on visits from 2022-01-01"," to ",date_end),
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
  hc_tooltip(shared = TRUE, borderColor = "black")
}) %>%
  hw_grid(ncol = 2, rowheight = 450) %>% htmltools::browsable()


rm(new_vol_trending)
rm(new_vol_trending_downtown)
invisible(gc())
```

### 4. Primary Care Access Trending
```{r Primary Care Median Wait Time Trending by Site, fig.width=12, fig.height = 5, fig.align = 'center', echo = FALSE, warning = FALSE, message = FALSE}
# new_wait_trend <- scheduling_data %>%
#   filter(Campus != "MSBI") %>%
#   filter(Appt.Made.DateYear >= date_start, Appt.Made.DateYear <= date_end) %>%
#   filter(New.PT2 == "New") %>%
#   # mutate(Appt.Made.Year = format(as.Date(Appt.Made.DTTM, format="%m/%d/%Y"), "%Y"),
#   #        Appt.Made.MonthYear = as.Date(paste0(format(as.Date(Appt.Made.DTTM, format="%m/%d/%Y"), "%Y-%m"), "-01"))) %>%
#   # filter(Appt.Made.Year >= 2021) %>%
#   filter(Campus.Specialty %in% c("Internal Medicine", "Family Medicine")) %>%
#   filter(Wait.Time >= 0) %>%
#   mutate(Wait.Time = as.numeric(Wait.Time)) %>%
#   group_by(Appt.Made.MonthYear, Campus) %>%
#   summarise(waitTime = round(median(Wait.Time, na.rm = TRUE)))
#
#
# # Missing Charges Trending Graph
# new_wait_trend %>%
#   hchart('line',
#          hcaes(x = 'Appt.Made.MonthYear', y = 'waitTime', group = 'Campus')) %>%
#   hc_chart(plotBorderWidth = 1
#            # borderColor = "#7f7f7f",
#            # borderWidth = 1
#            ) %>%
#   hc_title(text = "Monthly Trending of Primary Care Time to New Appointment (Median in Days)",
#            style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
#   hc_colors(site_cols) %>%
#   hc_plotOptions(series = list(marker = list(symbol = "circle"), lineWidth = 2, fillOpacity = 0.1)) %>%
#   hc_yAxis(title = list(text = "Days")) %>%
#            # plotLines = list(list(color = "red", width = 2, value = 80, dashStyle = "dash"))) %>%
#   hc_xAxis(title = list(enabled = FALSE)) %>%
#            # type = "datetime",
#            # dateTimeLabelFormats = list(month = '%Y-%m')) %>%
#   hc_legend(align = "center", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
#   hc_tooltip(shared = TRUE, borderColor = "black")
```


```{r Primary Care New Percent Trending by Site, echo = FALSE, warning = FALSE, message = FALSE}
# New Patients Scheduled within 14 days --------------------------------------------------------------------
new_perc_trend <- scheduling_data %>%
  filter(Campus != "MSBI") %>%
  filter(Appt.Made.Year == 2022) %>%
  filter(Appt.Made.DateYear <= date_end) %>%
  # filter(Appt.Made.DateYear >= date_start, Appt.Made.DateYear <= date_end) %>%
  filter(New.PT2 == "New") %>%
  # mutate(Appt.Made.MonthYear = as.Date(paste0(format(as.Date(Appt.Made.DTTM, format="%m/%d/%Y"), "%Y-%m"), "-01"))) %>%
  filter(Campus.Specialty %in% c("Internal Medicine", "Family Medicine")) %>%
  filter(Wait.Time >= 0) %>%
  mutate(Wait.Time = as.numeric(Wait.Time)) %>%
  mutate(within.14 = ifelse(Wait.Time <= 14, "Yes","No")) %>%
  group_by(Campus, Appt.Made.MonthYear, within.14) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = within.14,
              values_from = count,
              values_fill = 0) %>%
  mutate(total = Yes + No,
         new_14days = round((Yes/(total))*100))
map(unique(new_perc_trend$Campus), function(x){
highchart() %>%
  hc_yAxis_multiples(
    list(title = list(text = "Total New Patients"), lineWidth = 3),
    list(title = list(text = "% of New Patients"), labels = list(format = '{value}%'),
         showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = new_perc_trend$Appt.Made.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%m/%d}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name = "Total New Patients Scheduled",
                data = (new_perc_trend %>% filter(Campus == x))$total,
                type = 'column',
                color='#a5a7a5',
                dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name = "% New Patients Scheduled <=14 Days",
                data = (new_perc_trend %>% filter(Campus == x))$new_14days,
                type = "line", yAxis = 1,
                color='#d80b8c',
                lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}%')) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0(x, " - % New Patients Scheduled <=14 Days"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = paste0("Based on visits from 2022-01-01"," to ",date_end),
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
  hc_tooltip(shared = TRUE, borderColor = "black")
}) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

invisible(gc())
```


<!-- ### 4. No Show Rate Trending -->
```{r No Show Metric Trending by Site, fig.width=12, fig.height = 5, fig.align = 'center', echo = FALSE, warning = FALSE, message = FALSE}
# no_show_rate_trend <- scheduling_data %>%
#   filter(Appt.Status %in% c("Arrived","No Show")) %>%
#    filter(Appt.DateYear >= date_start, Appt.DateYear <= date_end) %>%
#   group_by(Campus, Appt.MonthYear, Appt.Status) %>%
#   summarise(total = n()) %>%
#   pivot_wider(names_from = Appt.Status,
#               values_from = total) %>%
#   mutate(noShow_rate = round((`No Show`/(Arrived+`No Show`))*100,0))
#
#
# # Missing Charges Trending Graph
# no_show_rate_trend %>%
#   hchart('line',
#          hcaes(x = 'Appt.MonthYear', y = 'noShow_rate', group = 'Campus')) %>%
#   hc_chart(plotBorderWidth = 0
#            # borderColor = "#7f7f7f",
#            # borderWidth = 1
#            ) %>%
#   hc_title(text = "Monthly Trending of No Show Rate by Site",
#            style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
#   hc_colors(site_cols) %>%
#   hc_plotOptions(series = list(format = "{point.y}%", marker = list(symbol = "circle"), lineWidth = 2, fillOpacity = 0.1)) %>%
#   hc_yAxis(title = list(text = "% No Show"),
#            # max = 100,
#            labels = list(format = '{value}%')) %>%
#            # plotLines = list(list(color = "red", width = 2, value = 80, dashStyle = "dash"))) %>%
#   hc_xAxis(title = list(enabled = FALSE)) %>%
#   hc_legend(align = "center", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
#   hc_tooltip(shared = TRUE, borderColor = "black",valueSuffix = '%')
```


### 5. Hand Hygiene Trending
```{r Hand Hygiene Metric Trending by Site, fig.width=12, fig.height = 5, fig.align = 'center', echo = FALSE, warning = FALSE, message = FALSE}
hh_site <- hh_data_merged %>%
  mutate(Month = format(as.Date(date, format="%Y-%m-%d"), "%Y-%m")) %>%
  filter(date >= date_start)
# test <- hh_site %>%
#   mutate(Group = ifelse(str_detect(role,"aft"), "After","Before")) %>%
#   group_by(site, Month) %>%
#   summarise(Yes = sum(Yes),
#             No = sum(No),
#             total_obs = sum(total_obs)) %>%
#   mutate(yes_perc = round((Yes/total_obs)*100),
#          no_perc = round((No/total_obs)*100))
hh_site <- hh_site %>%
  filter(unit != "NULL") %>%
  group_by(site, Month) %>%
  summarise(worker___1 = sum(worker___1),
            worker___2 = sum(worker___2),
            worker___3 = sum(worker___3),
            provider_hands_bef = sum(provider_hands_bef),
            provider_hands_aft = sum(provider_hands_aft),
            nurse_hands_bef = sum(nurse_hands_bef),
            nurse_hands_aft = sum(nurse_hands_aft),
            mt_hands_bef = sum(mt_hands_bef),
            mt_hands_aft = sum(mt_hands_aft))
hh_site <- hh_site %>%
  group_by(site, Month) %>%
  mutate(total_obs = sum(worker___1,worker___2,worker___3),
         total_comp = round((sum(max(provider_hands_bef,provider_hands_aft),
                          max(nurse_hands_bef, nurse_hands_aft),
                          max(mt_hands_bef, mt_hands_aft))/total_obs)*100)) %>%
  dplyr::select(site, Month, total_obs, total_comp)
network <- data.frame(site = "NETWORK",
                      Month = "2022-04",
                      total_obs = 0,
                      total_comp = 0)
msw <- data.frame(site = "MSW",
                      Month = "2022-05",
                      total_obs = 0,
                      total_comp = 0)
msdfp <- data.frame(site = "MSDFP",
                      Month = "2022-04",
                      total_obs = 0,
                      total_comp = 0)
hh_site <- bind_rows(hh_site, network, msw, msdfp)
hh_site <- hh_site %>%
  arrange(site, Month)
  map(unique(hh_site$site), function(x){
highchart() %>%
  hc_yAxis_multiples(
    list(title = list(text = "Total Observations"), lineWidth = 3),
    list(title = list(text = "% Compliance"), labels = list(format = '{value}%'),
         showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories =(hh_site %>% filter(site == x))$Month,
           # type = "datetime",
           # labels = list(format = '{value:%m/%d}')
           dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name = "Total Observations Submitted",
                data = (hh_site %>% filter(site == x))$total_obs,
                type = 'column',
                color='#00aeef',
                dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name = "% Observations Complied",
                data = (hh_site %>% filter(site == x))$total_comp,
                type = "line", yAxis = 1,
                color='#d80b8c',
                lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}%')) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0(x, " - Hand Hygiene Compliance %"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  # hc_subtitle(text = paste0("Based on visits from ",date_start," to ",date_end),
  #             align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
  hc_tooltip(shared = TRUE, borderColor = "black")
}) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()
  
  
invisible(gc())
```


--------------------------------------------------------------------------------
```{r Hand Hygiene Trending Summarized, echo = FALSE, warning = FALSE, message = FALSE}
hh_downtown <- hh_data_merged %>%
  mutate(Month = format(as.Date(date, format="%Y-%m-%d"), "%Y-%m")) %>%
  filter(date >= date_start)
hh_downtown <- hh_downtown %>%
  filter(unit != "NULL") %>%
  filter(site %in% c("MSUS","MSDD","MSBI")) %>%
  mutate(site = "MS Downtown") %>%
  group_by(site, Month) %>%
  summarise(worker___1 = sum(worker___1),
            worker___2 = sum(worker___2),
            worker___3 = sum(worker___3),
            provider_hands_bef = sum(provider_hands_bef),
            provider_hands_aft = sum(provider_hands_aft),
            nurse_hands_bef = sum(nurse_hands_bef),
            nurse_hands_aft = sum(nurse_hands_aft),
            mt_hands_bef = sum(mt_hands_bef),
            mt_hands_aft = sum(mt_hands_aft))
hh_downtown <- hh_downtown %>%
  group_by(site, Month) %>%
  mutate(total_obs = sum(worker___1,worker___2,worker___3),
         total_comp = round((sum(min(provider_hands_bef,provider_hands_aft),
                          min(nurse_hands_bef, nurse_hands_aft),
                          min(mt_hands_bef, mt_hands_aft))/total_obs)*100)) %>%
  dplyr::select(site, Month, total_obs, total_comp)
map(unique(hh_downtown$site), function(x){
highchart() %>%
  hc_yAxis_multiples(
    list(title = list(text = "Total Observations"), lineWidth = 3),
    list(title = list(text = "% Compliance"), labels = list(format = '{value}%'),
         showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories =(hh_downtown %>% filter(site == x))$Month,
           # type = "datetime",
           # labels = list(format = '{value:%m/%d}')
           dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  hc_add_series(name = "Total Observations Submitted",
                data = (hh_downtown %>% filter(site == x))$total_obs,
                type = 'column',
                color='#00aeef',
                dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name = "% Observations Complied",
                data = (hh_downtown %>% filter(site == x))$total_comp,
                type = "line", yAxis = 1,
                color='#d80b8c',
                lineColor='#d80b8c',
                dataLabels = list(enabled = TRUE, format='{point.y}%')) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0(x, " - Hand Hygiene Compliance %"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  # hc_subtitle(text = paste0("Based on visits from ",date_start," to ",date_end),
  #             align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
  hc_tooltip(shared = TRUE, borderColor = "black")
}) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()
invisible(gc())
```

