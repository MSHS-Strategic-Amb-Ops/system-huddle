---
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
    fig_width: 7
    fig_height: 6
resource_files:
- hh_crosswalk.csv
- Rad_Onc_Data.csv
- Radiology_Data.csv
- Radiology_Site_Mapping.csv
- Epic Department Mapping Correction.csv
- hh_crosswalk.csv
- Radiology_Data.csv
- Rad_Onc_Data.csv
- Radiology_Site_Mapping.csv
- Epic Department Mapping Correction.csv
- open_encounters_exclusion.xlsx
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```
<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: auto;
  margin-right: auto;
}
</style>
<style>
.tocify {
color: black;
}
<!-- } -->
<!-- .tocify .tocify-header { -->
<!--     position: fixed; -->
<!--     <!-- top: 50px; --> -->
<!--     left: 50px; -->
<!--     width: 350px; -->
<!--     <!-- border: solid 3px black; --> -->
<!--     <!-- height: 200px; --> -->
<!--  border: none; -->
<!-- } -->
.tocify .tocify-header .active {
color: white;
background: #d80b8c;
font-weight: bold;
}
<!-- .tocify .tocify-item { -->
<!-- background: white; -->
<!-- color: black; -->
<!--  border: none; -->
<!-- } -->
</style>
<style>
  .nav-pills>li>a:hover, .nav-pills>li>a:focus, .nav-pills>li.active>a,     .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus{
     background-color: #212070;
     }
</style>
<style>
.container { width: 1800px; }
h2 {
  background-color: #dddedd;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h3 {
  background-color: #f2f2f2;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h4 {
  <!-- background-color: #dddedd; -->
  <!-- color: black; -->
  text-indent: 50px;
  <!-- font-weight: bold; -->
}
</style>
```{r Load Packages, echo = FALSE, warning = FALSE, message = FALSE}
# Load packages -----------------------------------------------------------------------------------
suppressMessages({
  memory.limit(size = 10000000)
  library(readxl)
  library(writexl)
  library(plyr)
  library(dplyr)
  library(data.table)
  library(zoo)
  library(shiny)
  library(shinydashboard)
  library(shinydashboardPlus)
  library(shinyWidgets)
  library(htmlwidgets)
  library(lubridate)
  library(tcltk)
  library(tidyverse)
  library(plotly)
  library(knitr)
  library(kableExtra)
  library(leaflet)
  library(grid)
  library(gridExtra)
  library(eeptools)
  library(ggQC)
  #library(zipcode)
  library(utils)
  library(scales)
  library(chron)
  library(bupaR)
  library(shiny)
  library(DT)
  library(DiagrammeR)
  library(shinyalert)
  library(edeaR)
  library(processmapR)
  library(processmonitR)
  library(processanimateR)
  library(tidyr)
  library(lubridate)
  library(RColorBrewer)
  library(DiagrammeR)
  library(ggplot2)
  library(leaflet)
  library(readr)
  library(highcharter)
  library(ggforce) # for 'geom_arc_bar'
  library(packcircles) # for packed circle graph
  library(viridis)
  library(ggiraph)
  library(treemapify)
  library(treemap)
  library(broom)
  library(extrafont)
  library(tis) # for US holidays
  library(vroom)
  library(sjmisc)
  library(tools)
  library(here)
  library(shinyBS)
  library(shinyscreenshot)
  library(fasttime)
  library(shinycssloaders)
  library(feather)
  # library(zipcodeR)
  library(formattable)
  library(shinyjs)
  library(janitor)
  library(patchwork)
  library(RODBC)
  library(DBI)
  library(odbc)
})
```


```{r Graph asthetics, echo = FALSE, warning = FALSE, message = FALSE}
### Color Functions for Graphs ============================================================
# Mount Sinai corporate colors "USE THIS TO ADD COLORS"
MountSinai_colors <- c(
  `dark purple`  = "#212070",
  `dark pink`    = "#d80b8c",
  `dark blue`    = "#00aeef",
  `dark grey`    = "#7f7f7f",
  `yellow`       = "#ffc000",
  `purple`       = "#7030a0",
  `med purple`   = "#5753d0",
  `med pink`     = "#f75dbe",
  `med blue`     = "#5cd3ff",
  `med grey`     = "#a5a7a5",
  `light purple` = "#c7c6ef",
  `light pink`   = "#fcc9e9",
  `light blue`   = "#c9f0ff",
  `light grey`   = "#dddedd"
  )
# Function to extract Mount Sinai colors as hex codes
# Use Character names of MountSinai_colors
MountSinai_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (MountSinai_colors)
  
  MountSinai_colors[cols]
}
# Color Function that can be used to call all colors is "MountSinai_cols()"
# Use in ggplot 
  #MountSinai_cols()       # will provide all colors and their hex codes in a table 
  #MountSinai_cols("pink") # will provide color name and the hex code for the pink color
# Create palettes 
MountSinai_palettes <- list(
  `all`   = MountSinai_cols("dark purple","dark pink","dark blue","dark grey",
                            "med purple","med pink","med blue","med grey", 
                            "light purple","light pink","light blue","light grey"),
  
  `main`  = MountSinai_cols("dark purple","dark pink","dark blue","dark grey"),
  
  `purple`  = MountSinai_cols("dark purple","med purple","light purple"),
  
  `pink`  = MountSinai_cols("dark pink","med pink","light pink"),
  
  `blue`  = MountSinai_cols("dark blue", "med blue", "light blue"),
  
  `grey`  = MountSinai_cols("dark grey", "med grey", "light grey"),
  
  `purpleGrey` = MountSinai_cols("dark purple", "dark grey"),
  
  `pinkBlue` = MountSinai_cols("dark pink", "dark blue")
  
)
# MountSinai_palettes
# Return function to interpolate a Mount Sinai color palette
# default value is the main palette, reverse = True will change the order
MountSinai_pal <- function(palette = "all", reverse = FALSE, ...) {
  pal <- MountSinai_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}
# Scale Function for ggplot can be used instead of scale_color_manual
scale_color_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}
# Scale Fill for ggplot insetead of scale_fill_manual 
scale_fill_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  if (discrete) {
    discrete_scale("fill", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}
# Use in ggplot 
  # scale_color_MountSinai("main")
```


```{r Import HH Data, echo = FALSE, warning = FALSE, message = FALSE}
# con_hh <- odbcConnect("handhygiene") # Connect to Server
# hh_data_comp_raw <- sqlQuery(con_hh, "SELECT * FROM qidm_dev.dbo.amb_hand_hygiene_comp") # Master Referrals Data

# Import Referrals+Visit Data --------------------------------------------------
con_hh <- dbConnect(odbc(),
                    Driver = "SQLServer",
                    Server = "10.2.42.69",
                    UID = "kweons01",
                    PWD = "Pasword01#PasPasword01#Pas",
                    Port = 1433)     
hh_data_comp_raw <- dbGetQuery(con_hh, "SELECT * FROM qidm_dev.dbo.amb_hand_hygiene_comp")
hh_data_comp_raw <- as.data.frame(hh_data_comp_raw)
hh_data_comp_raw <- hh_data_comp_raw %>%
  mutate_all(as.character) %>%
  mutate(record_id = as.numeric(record_id),
         unit_complete = as.numeric(unit_complete))



# write.csv(hh_data_comp_raw, "/nfs/data/Applications/Ambulatory/hh_crosswalk.csv", row.names=FALSE)

hh_data_comp_raw_csv <-  as.data.frame(read_csv("/nfs/data/Applications/Ambulatory/hh_comp.csv"))
hh_crosswalk <- as.data.frame(read_csv("/nfs/data/Applications/Ambulatory/hh_crosswalk.csv"))
# hh_data_comp_raw_csv <-  as.data.frame(read_csv("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/hh_comp.csv"))
# hh_crosswalk <- as.data.frame(read_csv("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/server-upload/hh_crosswalk.csv"))

 
```

```{r}

str(hh_data_comp_raw)
str(hh_data_comp_raw_csv)
```


```{r Hand Hygiene Data Processing, echo = FALSE, warning = FALSE, message = FALSE}
colnames(hh_data_comp_raw) <- tolower(colnames(hh_data_comp_raw))
# colnames(hh_data_comp_raw)[which(colnames(hh_data_comp_raw) == "data_date")] <- "date"
# Map MSD units
hh_data_comp_raw$site<- ifelse(hh_data_comp_raw$site == "MSD",
                                hh_crosswalk$unit[match(hh_data_comp_raw$msd_unit, hh_crosswalk$Location)], hh_data_comp_raw$site)
# Map msh_unit
hh_data_comp_raw$site<- ifelse(hh_data_comp_raw$site == "MSH",
                                hh_crosswalk$unit[match(hh_data_comp_raw$msh_unit, hh_crosswalk$Location)], hh_data_comp_raw$site)
hh_data_comp <- hh_data_comp_raw %>%
  dplyr::select(-language) %>%
  pivot_longer(
    c("msh_unit","msd_unit","nyee_unit","msq_unit","msm_unit","msw_unit","net_unit"),
    names_to = "unit_site",
    values_to = "unit"
  ) %>%
  filter(date != "NULL") %>%
  mutate_if(is.numeric, as.character) %>%
  filter(!is.na(site))
# hh_data_msd <- hh_data_msd_raw %>%
#     filter(language != "NULL") %>%
#   rename(date = data_date) %>%
#   dplyr::select(-language) %>%
#   mutate_if(is.numeric, as.character)
#
# hh_data_raw <- bind_rows(hh_data_comp, hh_data_msd)
hh_data_merged <- hh_data_comp %>%
  filter(!site %in% c("MS NOW", "MSHP", "NYEE", "MSQ","OTHER")) %>%
  filter(!is.na(site)) %>%
  select(site, unit, date, worker___1, worker___2, worker___3, provider_hands_bef, provider_hands_aft, nurse_hands_bef, nurse_hands_aft, mt_hands_bef, mt_hands_aft) %>%
  mutate(across(4:12, as.numeric)) %>%
  mutate_if(is.numeric, ~ifelse(is.na(.),0,.)) %>%
  mutate_if(is.numeric, ~ifelse(.==2,0,.)) %>%
  group_by(site, unit, date) %>%
  summarise(worker___1 = sum(worker___1),
            worker___2 = sum(worker___2),
            worker___3 = sum(worker___3),
            provider_hands_bef = sum(provider_hands_bef),
            provider_hands_aft = sum(provider_hands_aft),
            nurse_hands_bef = sum(nurse_hands_bef),
            nurse_hands_aft = sum(nurse_hands_aft),
            mt_hands_bef = sum(mt_hands_bef),
            mt_hands_aft = sum(mt_hands_aft)) %>%
  mutate(date = as.Date(date, "%m/%d/%Y"),
         Appt.Year = as.numeric(strftime(date, format = "%Y")),
         Appt.WeekNum = lubridate::epiweek(date))
hh_data_merged_role <- hh_data_comp %>%
  filter(!site %in% c("MS NOW", "MSHP", "NYEE", "MSQ","OTHER")) %>%
  filter(!is.na(site)) %>%
  select(site, unit, date, provider_hands_bef, provider_hands_aft, nurse_hands_bef, nurse_hands_aft, mt_hands_bef, mt_hands_aft) %>%
  pivot_longer(provider_hands_bef: mt_hands_aft,
               names_to = "role",
               values_to = "compliance") %>%
  mutate(date = as.Date(date, "%m/%d/%Y"),
         Appt.Year = as.numeric(strftime(date, format = "%Y")),
         Appt.WeekNum = lubridate::epiweek(date),
         compliance = ifelse(compliance == 2,0,compliance)) %>%
  filter(!is.na(compliance)) %>%
  filter(compliance != 2) %>%
  group_by(site, unit, date, Appt.Year, Appt.WeekNum, role, compliance) %>%
  summarise(total_obs = n()) %>%
  mutate(compliance = ifelse(compliance == 0, "No", "Yes")) 

# %>%
#   pivot_wider(
#     names_from = compliance,
#     values_from = total_obs,
#     values_fill=list(total_obs=0)
#   ) 

str(hh_data_merged_role)
#   mutate(total_obs = Yes + No)
# # Change NET to NETWORK
# hh_data_merged <- hh_data_merged %>%
#   mutate(site = ifelse(site == "NET","NETWORK",site)) %>%
#   arrange(date) %>%
#   filter(unit != "NULL")
# hh_data_merged_role <- hh_data_merged_role %>%
#   mutate(site = ifelse(site == "NET","NETWORK",site)) %>%
#   arrange(date) %>%
#   filter(unit != "NULL")
```
